/**
 * Wootour Bulk Editor - Admin JavaScript
 * 
 * Main JavaScript file for the admin interface.
 * 
 * @package     WootourBulkEditor
 * @subpackage  Admin
 
 * @license     GPL-2.0+
 * @since       1.0.0
 */

(function($) {
    'use strict';

    // Namespace global du plugin
    window.WBE = window.WBE || {};

    // Configuration du plugin
    WBE.config = window.wbe_admin_data || {};
    WBE.state = {
        selectedProducts: new Set(),
        selectedDates: {
            specific: new Set(),
            exclusions: new Set()
        },
        currentCategory: 0,
        currentPage: 1,
        totalPages: 1,
        searchTerm: '',
        changes: {},
        currentOperation: null,
        isProcessing: false
    };

    $(document).ready(function() {
        WBE.init();
    });

    // Main initialization
    WBE.init = function() {
        WBE.UI.init();
        WBE.Products.init();
        WBE.Calendar.init();
        WBE.Dates.init();
        WBE.Actions.init();
        WBE.Modals.init();
        WBE.loadInitialData();
        WBE.bindEvents();
    };

    WBE.loadInitialData = function() {
        WBE.updateStatistics();
        
        WBE.Products.loadProducts();
        
        WBE.Calendar.initCalendars();
    };

    WBE.updateStatistics = function() {
        $('#wbe-total-products').text(WBE.config.statistics?.total_products || 0);
        $('#wbe-wootour-count').text(WBE.config.statistics?.with_wootour || 0);
        $('#wbe-selected-count').text(WBE.state.selectedProducts.size);
    };

    WBE.bindEvents = function() {
        $(window).on('resize', WBE.UI.handleResize);
        
        $(window).on('beforeunload', function(e) {
            if (WBE.state.isProcessing) {
                e.preventDefault();
                e.returnValue = WBE.config.i18n?.confirmLeave || 'Les changements en cours seront perdus. Êtes-vous sûr de vouloir quitter ?';
                return e.returnValue;
            }
        });
        
        $(document).on('keydown', function(e) {
            // Ctrl/Cmd + Enter pour appliquer les changements
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                $('#wbe-apply-btn').trigger('click');
            }
            if (e.key === 'Escape') {
                $('.wbe-modal-close').trigger('click');
            }
        });
    };

    WBE.ajax = function(action, data, successCallback, errorCallback) {
        const defaultData = {
            action: action,
            nonce: WBE.config.nonce,
            _ajax_nonce: WBE.config.nonce
        };
        
        const requestData = $.extend({}, defaultData, data);
        
        return $.ajax({
            url: WBE.config.ajax_url,
            type: 'POST',
            data: requestData,
            dataType: 'json',
            beforeSend: function() {
                WBE.UI.showLoading();
            },
            success: function(response) {
                WBE.UI.hideLoading();
                
                if (response.success) {
                    if (typeof successCallback === 'function') {
                        successCallback(response.data, response);
                    }
                } else {
                    WBE.UI.showError(response.error?.message || 'Erreur lors de la requête AJAX');
                    if (typeof errorCallback === 'function') {
                        errorCallback(response.error, response);
                    }
                }
            },
            error: function(xhr, status, error) {
                WBE.UI.hideLoading();
                WBE.UI.showError('Server error: ' + error);
                console.error('AJAX Error:', error, xhr);
                
                if (typeof errorCallback === 'function') {
                    errorCallback(error, xhr);
                }
            }
        });
    };

    WBE.notify = function(message, type = 'info', duration = 5000) {
        const toast = $('<div>').addClass('wbe-toast ' + type).text(message);
        
        $('#wbe-toast-container').append(toast);
        
        setTimeout(function() {
            toast.fadeOut(300, function() {
                $(this).remove();
            });
        }, duration);
        
        toast.on('click', function() {
            $(this).fadeOut(300, function() {
                $(this).remove();
            });
        });
    };

    WBE.UI = {
        init: function() {
            this.cacheElements();
            this.initTooltips();
        },
        
        cacheElements: function() {
            this.$body = $('body');
            this.$loading = $('.wbe-loading');
        },
        
        initTooltips: function() {
            if ($.fn.tooltip) {
                $('[title]').tooltip();
            }
        },
        
        showLoading: function(message) {
            const msg = message || WBE.config.i18n?.loading || 'Chargement...';
            this.$loading.find('span:not(.spinner)').text(msg);
            this.$loading.show();
        },
        
        hideLoading: function() {
            this.$loading.hide();
        },
        
        showError: function(message) {
            WBE.notify(message, 'error', 10000);
            console.error('WBE Error:', message);
        },
        
        showSuccess: function(message) {
            WBE.notify(message, 'success');
        },
        
        showWarning: function(message) {
            WBE.notify(message, 'warning', 8000);
        },
        
        showInfo: function(message) {
            WBE.notify(message, 'info');
        },
        
        handleResize: function() {
            if ($(window).width() < 782) {
                $('body').addClass('wbe-mobile');
            } else {
                $('body').removeClass('wbe-mobile');
            }
        },
        
        confirmDialog: function(message, callback) {
            if (confirm(message)) {
                if (typeof callback === 'function') {
                    callback();
                }
                return true;
            }
            return false;
        },
        
        updateProgress: function(percentage, text, timeRemaining) {
            const $fill = $('#wbe-progress-fill');
            const $percentage = $('#wbe-progress-percentage');
            const $text = $('#wbe-progress-text');
            const $time = $('#wbe-time-remaining');
            
            percentage = Math.min(100, Math.max(0, percentage));
            
            $fill.css('width', percentage + '%');
            $percentage.text(percentage.toFixed(1) + '%');
            $text.text(text || '');
            
            if (timeRemaining) {
                $time.text('(' + timeRemaining + ' ' + (WBE.config.i18n?.seconds || 'seconds') + ')');
            } else {
                $time.text('');
            }
        },
        
        toggleProgressBar: function(show) {
            const $container = $('#wbe-progress-container');
            if (show) {
                $container.slideDown();
            } else {
                $container.slideUp();
            }
        }
    };

    WBE.Products = {
        init: function() {
            this.cacheElements();
            this.bindEvents();
        },
        
        cacheElements: function() {
            this.$categorySelect = $('#wbe-category-select');
            this.$productSearch = $('#wbe-product-search');
            this.$searchBtn = $('#wbe-search-btn');
            this.$productList = $('#wbe-product-list');
            this.$selectAll = $('#wbe-select-all');
            this.$deselectAll = $('#wbe-deselect-all');
            this.$prevPage = $('#wbe-prev-page');
            this.$nextPage = $('#wbe-next-page');
            this.$currentPage = $('#wbe-current-page');
            this.$totalPages = $('#wbe-total-pages');
        },
        
        bindEvents: function() {
            this.$categorySelect.on('change', this.handleCategoryChange.bind(this));
            $('#wbe-load-category').on('click', this.loadProducts.bind(this));
            
            this.$searchBtn.on('click', this.handleSearch.bind(this));
            this.$productSearch.on('keypress', function(e) {
                if (e.which === 13) {
                    WBE.Products.handleSearch();
                }
            });
            this.$selectAll.on('click', this.selectAll.bind(this));
            this.$deselectAll.on('click', this.deselectAll.bind(this));
            
            this.$prevPage.on('click', this.prevPage.bind(this));
            this.$nextPage.on('click', this.nextPage.bind(this));
        },
        
        loadProducts: function(page = 1) {
            const categoryId = WBE.state.currentCategory;
            const searchTerm = WBE.state.searchTerm;
            
            WBE.ajax('wbe_get_products', {
                category_id: categoryId,
                page: page,
                search: searchTerm,
                per_page: 50
            }, this.handleProductsLoaded.bind(this), this.handleProductsError.bind(this));
        },
        
        handleProductsLoaded: function(data) {
            this.renderProducts(data.products);
            this.updatePagination(data.pagination);
            WBE.state.currentPage = data.pagination.current_page;
            WBE.state.totalPages = data.pagination.total_pages;
        },
        
        handleProductsError: function(error) {
            WBE.UI.showError(error.message || 'Echec du chargement des produits');
        },
        
        renderProducts: function(products) {
            if (!products || products.length === 0) {
                this.$productList.html('<div class="wbe-empty-state">' + 
                    (WBE.config.i18n?.noProductsFound || 'Aucun produit trouvé') + 
                    '</div>');
                return;
            }
            
            let html = '<table class="wp-list-table widefat fixed striped wbe-product-table">';
            html += '<thead><tr>' +
                '<th class="check-column"><input type="checkbox" id="wbe-bulk-select-all"></th>' +
                '<th class="column-primary">' + (WBE.config.i18n?.product || 'Product') + '</th>' +
                '<th>' + (WBE.config.i18n?.sku || 'SKU') + '</th>' +
                '<th>' + (WBE.config.i18n?.categories || 'Categories') + '</th>' +
                '<th>' + (WBE.config.i18n?.price || 'Price') + '</th>' +
                '<th>' + (WBE.config.i18n?.wootour || 'Wootour') + '</th>' +
                '</tr></thead><tbody>';
            
            products.forEach(function(product) {
                const isSelected = WBE.state.selectedProducts.has(product.id);
                const hasWootour = product.has_wootour;
                
                html += '<tr class="wbe-product-row" data-product-id="' + product.id + '">' +
                    '<th scope="row" class="check-column">' +
                    '<input type="checkbox" class="wbe-product-checkbox" ' +
                    'name="product_ids[]" value="' + product.id + '" ' +
                    'data-product-name="' + product.name.replace(/"/g, '&quot;') + '" ' +
                    (isSelected ? 'checked' : '') + '>' +
                    '</th>' +
                    '<td class="column-primary">' +
                    '<div class="wbe-product-info">' +
                    (product.image_url ? '<img src="' + product.image_url + '" class="wbe-product-thumb">' : '') +
                    '<div class="wbe-product-details">' +
                    '<strong class="wbe-product-name">' +
                    '<a href="' + product.edit_url + '" target="_blank">' + product.name + '</a>' +
                    '</strong>' +
                    '<div class="row-actions">' +
                    '<span class="edit"><a href="' + product.edit_url + '" target="_blank">' + 
                    (WBE.config.i18n?.edit || 'Edit') + '</a></span> | ' +
                    '<span class="view"><a href="' + product.view_url + '" target="_blank">' + 
                    (WBE.config.i18n?.view || 'View') + '</a></span>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</td>' +
                    '<td><code>' + (product.sku || '') + '</code></td>' +
                    '<td>' + (product.categories || '') + '</td>' +
                    '<td>' + product.price + '</td>' +
                    '<td>' +
                    '<span class="wbe-status-badge ' + (hasWootour ? 'wbe-status-active' : 'wbe-status-inactive') + '">' +
                    '<span class="dashicons dashicons-' + (hasWootour ? 'yes' : 'no') + '"></span>' +
                    (hasWootour ? 
                        (WBE.config.i18n?.active || 'Active') : 
                        (WBE.config.i18n?.inactive || 'Inactive')) +
                    '</span>' +
                    '</td>' +
                    '</tr>';
            });
            
            html += '</tbody></table>';
            
            this.$productList.html(html);
            
            this.bindCheckboxEvents();
        },
        
        bindCheckboxEvents: function() {
            const self = this;
            
            $('#wbe-bulk-select-all').off('change').on('change', function() {
                const isChecked = $(this).is(':checked');
                $('.wbe-product-checkbox').prop('checked', isChecked).trigger('change');
            });
            
            $('.wbe-product-checkbox').off('change').on('change', function() {
                const productId = parseInt($(this).val());
                const productName = $(this).data('product-name');
                const isChecked = $(this).is(':checked');
                
                if (isChecked) {
                    WBE.state.selectedProducts.add(productId);
                } else {
                    WBE.state.selectedProducts.delete(productId);
                }
                
                $('#wbe-selected-count').text(WBE.state.selectedProducts.size);
                
                const totalCheckboxes = $('.wbe-product-checkbox').length;
                const checkedCheckboxes = $('.wbe-product-checkbox:checked').length;
                $('#wbe-bulk-select-all').prop('checked', 
                    totalCheckboxes > 0 && checkedCheckboxes === totalCheckboxes);
                
                const $row = $(this).closest('.wbe-product-row');
                if (isChecked) {
                    $row.addClass('selected');
                } else {
                    $row.removeClass('selected');
                }
                
                WBE.UI.showInfo(
                    (isChecked ? 'Selected: ' : 'Deselected: ') + productName
                );
            });
        },
        
        updatePagination: function(pagination) {
            this.$currentPage.text(pagination.current_page);
            this.$totalPages.text(pagination.total_pages);
            this.$prevPage.prop('disabled', pagination.current_page <= 1);
            this.$nextPage.prop('disabled', pagination.current_page >= pagination.total_pages);
        },
        
        handleCategoryChange: function() {
            WBE.state.currentCategory = parseInt(this.$categorySelect.val());
            WBE.state.searchTerm = '';
            this.$productSearch.val('');
            WBE.state.currentPage = 1;
            this.loadProducts();
        },
        
        handleSearch: function() {
            WBE.state.searchTerm = this.$productSearch.val().trim();
            WBE.state.currentCategory = 0;
            this.$categorySelect.val('0');
            WBE.state.currentPage = 1;
            this.loadProducts();
        },
        
        selectAll: function() {
            $('.wbe-product-checkbox').prop('checked', true).trigger('change');
        },
        
        deselectAll: function() {
            $('.wbe-product-checkbox').prop('checked', false).trigger('change');
        },
        
        prevPage: function() {
            if (WBE.state.currentPage > 1) {
                WBE.state.currentPage--;
                this.loadProducts(WBE.state.currentPage);
            }
        },
        
        nextPage: function() {
            if (WBE.state.currentPage < WBE.state.totalPages) {
                WBE.state.currentPage++;
                this.loadProducts(WBE.state.currentPage);
            }
        },
        
        getSelectedProductIds: function() {
            return Array.from(WBE.state.selectedProducts);
        }
    };

    WBE.Calendar = {
        init: function() {
            this.cacheElements();
            this.initDatepickers();
        },
        
        cacheElements: function() {
            this.$startDate = $('#wbe-start-date');
            this.$endDate = $('#wbe-end-date');
        },
        
        initDatepickers: function() {
            const dateFormat = WBE.config.date_format_js || 'dd/mm/yy';
            
            this.$startDate.datepicker({
                dateFormat: dateFormat,
                onSelect: function(dateText) {
                    WBE.state.changes.start_date = dateText;
                    WBE.Dates.updateStartDate(dateText);
                }
            });
            
            this.$endDate.datepicker({
                dateFormat: dateFormat,
                onSelect: function(dateText) {
                    WBE.state.changes.end_date = dateText;
                    WBE.Dates.updateEndDate(dateText);
                }
            });
            
            $('.wbe-clear-date').on('click', function() {
                const target = $(this).data('target');
                $('#' + target).val('');
                
                if (target === 'wbe-start-date') {
                    delete WBE.state.changes.start_date;
                } else if (target === 'wbe-end-date') {
                    delete WBE.state.changes.end_date;
                }
            });
        },
        
        initCalendars: function() {
            console.log('Calendars initialized');
        }
    };
    WBE.Dates = {
        init: function() {
            this.cacheElements();
            this.bindEvents();
        },
        
        cacheElements: function() {
            this.$weekdayCheckboxes = $('.wbe-weekday-checkbox');
            this.$specificDatesList = $('#wbe-specific-dates-list');
            this.$exclusionsList = $('#wbe-exclusions-list');
            this.$clearSpecific = $('#wbe-clear-specific');
            this.$clearExclusions = $('#wbe-clear-exclusions');
        },
        
        bindEvents: function() {
            this.$weekdayCheckboxes.on('change', this.handleWeekdayChange.bind(this));
            
            this.$clearSpecific.on('click', this.clearSpecificDates.bind(this));
            this.$clearExclusions.on('click', this.clearExclusions.bind(this));
        },
        
        handleWeekdayChange: function() {
            const selectedDays = [];
            
            this.$weekdayCheckboxes.each(function() {
                if ($(this).is(':checked')) {
                    const dayName = $(this).attr('name').match(/\[(.*?)\]/)[1];
                    const dayMap = {
                        sunday: 0, monday: 1, tuesday: 2, wednesday: 3,
                        thursday: 4, friday: 5, saturday: 6
                    };
                    
                    if (dayMap[dayName] !== undefined) {
                        selectedDays.push(dayMap[dayName]);
                    }
                }
            });
            
            WBE.state.changes.weekdays = selectedDays;
        },
        
        updateStartDate: function(date) {
            if (WBE.state.changes.end_date) {
                const start = this.parseDate(date);
                const end = this.parseDate(WBE.state.changes.end_date);
                
                if (start > end) {
                    WBE.UI.showWarning(WBE.config.i18n?.dateConflict || 'La date de départ ne peut pas être après la date de fin');
                    this.$startDate.val('');
                    delete WBE.state.changes.start_date;
                    return;
                }
            }
        },
        
        updateEndDate: function(date) {
            if (WBE.state.changes.start_date) {
                const start = this.parseDate(WBE.state.changes.start_date);
                const end = this.parseDate(date);
                
                if (start > end) {
                    WBE.UI.showWarning(WBE.config.i18n?.dateConflict || 'La date de fin ne peut pas être avant la date de départ');
                    this.$endDate.val('');
                    delete WBE.state.changes.end_date;
                    return;
                }
            }
        },
        
        parseDate: function(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length === 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr);
        },
        
        formatDateForDisplay: function(dateStr) {
            const date = this.parseDate(dateStr);
            return date.toLocaleDateString(WBE.config.locale || 'en-GB', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        },
        
        addSpecificDate: function(date) {
            if (!WBE.state.selectedDates.specific.has(date)) {
                WBE.state.selectedDates.specific.add(date);
                this.renderDateTag(date, 'specific');
                this.updateChanges();
            }
        },
        
        addExclusionDate: function(date) {
            if (!WBE.state.selectedDates.exclusions.has(date)) {
                WBE.state.selectedDates.exclusions.add(date);
                this.renderDateTag(date, 'exclusion');
                this.updateChanges();
            }
        },
        
        removeDate: function(date, type) {
            if (type === 'specific') {
                WBE.state.selectedDates.specific.delete(date);
            } else {
                WBE.state.selectedDates.exclusions.delete(date);
            }
            
            this.updateChanges();
        },
        
        renderDateTag: function(date, type) {
            const $list = type === 'specific' ? this.$specificDatesList : this.$exclusionsList;
            const displayDate = this.formatDateForDisplay(date);
            
            const $tag = $('<div>').addClass('wbe-date-tag').html(
                displayDate +
                '<button type="button" data-date="' + date + '" data-type="' + type + '">&times;</button>'
            );
            
            $list.append($tag);
            
            $tag.find('button').on('click', function() {
                const date = $(this).data('date');
                const type = $(this).data('type');
                WBE.Dates.removeDate(date, type);
                $(this).closest('.wbe-date-tag').remove();
            });
        },
        
        clearSpecificDates: function() {
            WBE.state.selectedDates.specific.clear();
            this.$specificDatesList.empty();
            this.updateChanges();
            WBE.UI.showInfo(WBE.config.i18n?.specificDatesCleared || 'Specific dates cleared');
        },
        
        clearExclusions: function() {
            WBE.state.selectedDates.exclusions.clear();
            this.$exclusionsList.empty();
            this.updateChanges();
            WBE.UI.showInfo(WBE.config.i18n?.exclusionsCleared || 'Exclusions cleared');
        },
        
        updateChanges: function() {
            WBE.state.changes.specific = Array.from(WBE.state.selectedDates.specific);
            WBE.state.changes.exclusions = Array.from(WBE.state.selectedDates.exclusions);
        }
    };
    WBE.Actions = {
        init: function() {
            this.cacheElements();
            this.bindEvents();
        },
        
        cacheElements: function() {
            this.$previewBtn = $('#wbe-preview-btn');
            this.$applyBtn = $('#wbe-apply-btn');
            this.$resetBtn = $('#wbe-reset-btn');
            this.$cancelProcess = $('#wbe-cancel-process');
            this.$resumeProcess = $('#wbe-resume-process');
        },
        
        bindEvents: function() {
            this.$previewBtn.on('click', this.previewChanges.bind(this));
            this.$applyBtn.on('click', this.applyChanges.bind(this));
            this.$resetBtn.on('click', this.resetForm.bind(this));
            this.$cancelProcess.on('click', this.cancelProcessing.bind(this));
            this.$resumeProcess.on('click', this.resumeProcessing.bind(this));
        },
        
        validateBeforeAction: function() {
            if (WBE.state.selectedProducts.size === 0) {
                WBE.UI.showError(WBE.config.i18n?.noProductsSelected || 'Veuillez sélectionner au moins un produit.');
                return false;
            }
            const hasChanges = Object.keys(WBE.state.changes).some(function(key) {
                const value = WBE.state.changes[key];
                if (Array.isArray(value)) {
                    return value.length > 0;
                }
                return value !== undefined && value !== '';
            });
            
            if (!hasChanges) {
                WBE.UI.showError(WBE.config.i18n?.noChangesSpecified || 'Veuillez spécifier au moins un changement à appliquer.');
                return false;
            }
            
            return true;
        },
        
        previewChanges: function() {
            if (!this.validateBeforeAction()) {
                return;
            }
            
            const productIds = WBE.Products.getSelectedProductIds();
            
            WBE.ajax('wbe_preview_changes', {
                product_ids: productIds,
                ...WBE.state.changes,
                sample_size: 5
            }, function(data) {
                WBE.Modals.showPreview(data);
            }, function(error) {
                WBE.UI.showError(error.message || 'Échec de l\'aperçu');
            });
        },
        
        applyChanges: function() {
            if (!this.validateBeforeAction()) {
                return;
            }
            
            const confirmMessage = WBE.config.i18n?.confirmApply || 
                'Etes vous sur de vouloir appliquer ces changements aux produits sélectionnés ? Cette action ne peut pas être annulée.';
            
            if (!WBE.UI.confirmDialog(confirmMessage)) {
                return;
            }
            
            const productIds = WBE.Products.getSelectedProductIds();
            
            WBE.state.isProcessing = true;
            WBE.UI.toggleProgressBar(true);
            WBE.UI.updateProgress(0, 'Démarrage...');
            
            WBE.ajax('wbe_process_batch', {
                product_ids: productIds,
                ...WBE.state.changes
            }, this.handleBatchResponse.bind(this), this.handleBatchError.bind(this));
        },
        
        handleBatchResponse: function(data) {
            WBE.state.currentOperation = data.operation_id;
            
            if (data.is_complete) {
                this.handleBatchComplete(data);
            } else {
                this.pollProgress(data.operation_id);
            }
        },
        
        handleBatchError: function(error, response) {
            WBE.state.isProcessing = false;
            WBE.UI.toggleProgressBar(false);
            
            if (response?.data?.can_resume) {
                WBE.UI.showWarning(error.message);
                WBE.UI.showInfo(WBE.config.i18n?.resumeAvailable || 'Vous pouvez reprendre cette opération.');
                $('#wbe-resume-process').show();
            } else {
                WBE.UI.showError(error.message || 'Échec de l\'opération');
            }
        },
        
        handleBatchComplete: function(data) {
            WBE.state.isProcessing = false;
            WBE.UI.toggleProgressBar(false);
            
            const message = WBE.config.i18n?.changesApplied || 'Changements appliqués avec succès.';
            const details = data.success_count + ' produits mis à jour, ' + 
                          data.failed_count + ' échoués.';
            
            WBE.UI.showSuccess(message + ' ' + details);
            
            WBE.Products.loadProducts(WBE.state.currentPage);
        },
        
        pollProgress: function(operationId) {
            const pollInterval = setInterval(function() {
                if (!WBE.state.isProcessing) {
                    clearInterval(pollInterval);
                    return;
                }
                
                WBE.ajax('wbe_get_progress', {
                    operation_id: operationId
                }, function(data) {
                    WBE.UI.updateProgress(
                        data.percentage,
                        data.processed + ' of ' + data.total + ' produits traités',
                        data.estimated_remaining + 's'
                    );
                    
                    if (data.percentage >= 100 || !data.can_resume) {
                        clearInterval(pollInterval);
                        WBE.state.isProcessing = false;
                        
                        if (data.percentage >= 100) {
                            
                            WBE.Actions.applyChanges();
                        }
                    }
                }, function() {
                   
                    clearInterval(pollInterval);
                });
            }, 2000);
        },
        
        cancelProcessing: function() {
            if (!WBE.state.currentOperation) {
                return;
            }
            
            const confirmMessage = WBE.config.i18n?.confirmCancel || 
                'Etes vous sur de vouloir annuler l\'opération en cours ?';
            
            if (!WBE.UI.confirmDialog(confirmMessage)) {
                return;
            }
            
            WBE.ajax('wbe_cancel_operation', {
                operation_id: WBE.state.currentOperation
            }, function() {
                WBE.state.isProcessing = false;
                WBE.UI.toggleProgressBar(false);
                WBE.UI.showInfo(WBE.config.i18n?.operationCancelled || 'Opération annulée.');
            });
        },
        
        resumeProcessing: function() {
            if (!WBE.state.currentOperation) {
                return;
            }
            
            WBE.ajax('wbe_resume_operation', {
                operation_id: WBE.state.currentOperation
            }, function(data) {
                WBE.state.isProcessing = true;
                WBE.UI.toggleProgressBar(true);
                WBE.Actions.handleBatchResponse(data);
                $('#wbe-resume-process').hide();
            });
        },
        
        resetForm: function() {
            WBE.state.selectedProducts.clear();
            WBE.state.changes = {};
            WBE.state.selectedDates.specific.clear();
            WBE.state.selectedDates.exclusions.clear();
            
            $('.wbe-product-checkbox').prop('checked', false);
            $('.wbe-product-row').removeClass('selected');
            $('.wbe-datepicker').val('');
            $('.wbe-weekday-checkbox').prop('checked', false);
            $('.wbe-dates-list').empty();
            
            WBE.updateStatistics();
            
            WBE.UI.showInfo(WBE.config.i18n?.formReset || 'Formulaire réinitialisé.');
        }
    };

    WBE.Modals = {
        init: function() {
            this.cacheElements();
            this.bindEvents();
        },
        
        cacheElements: function() {
            this.$modals = $('.wbe-modal');
            this.$previewModal = $('#wbe-preview-modal');
            this.$logsModal = $('#wbe-logs-modal');
            this.$helpModal = $('#wbe-help-modal');
            this.$modalClose = $('.wbe-modal-close');
            this.$viewLogs = $('.wbe-view-logs');
            this.$helpToggle = $('.wbe-help-toggle');
            this.$confirmApply = $('#wbe-confirm-apply');
        },
        
        bindEvents: function() {
            this.$modalClose.on('click', this.closeAllModals.bind(this));
            
            $(window).on('click', function(e) {
                if ($(e.target).hasClass('wbe-modal')) {
                    WBE.Modals.closeAllModals();
                }
            });
            
            this.$viewLogs.on('click', this.showLogsModal.bind(this));
            this.$helpToggle.on('click', this.showHelpModal.bind(this));
            this.$confirmApply.on('click', function() {
                WBE.Modals.closeAllModals();
                $('#wbe-apply-btn').trigger('click');
            });
        },
        
        showPreview: function(data) {
            let html = '<div class="wbe-preview-content">';
            
            if (data.summary?.has_errors) {
                html += '<div class="notice notice-error"><p>' +
                    (WBE.config.i18n?.previewErrors || 'Erreurs détectées dans l\'aperçu:') +
                    '</p><ul>';
                
                data.samples.forEach(function(sample) {
                    if (sample.error) {
                        html += '<li><strong>' + sample.product_name + ':</strong> ' + sample.error + '</li>';
                    }
                });
                
                html += '</ul></div>';
            }
            
            html += '<h3>' + (WBE.config.i18n?.previewSummary || 'Summary') + '</h3>';
            html += '<p>' + (data.summary?.message || '') + '</p>';
            
            html += '<h3>' + (WBE.config.i18n?.sampleProducts || 'Sample Products') + '</h3>';
            html += '<div class="wbe-preview-samples">';
            
            data.samples.forEach(function(sample) {
                html += '<div class="wbe-preview-sample">';
                html += '<h4>' + sample.product_name + '</h4>';
                
                if (sample.conflicts && sample.conflicts.length > 0) {
                    html += '<div class="wbe-preview-conflicts">';
                    sample.conflicts.forEach(function(conflict) {
                        html += '<div class="wbe-preview-conflict wbe-preview-' + conflict.type + '">';
                        html += '<strong>' + conflict.type + ':</strong> ' + conflict.message;
                        html += '</div>';
                    });
                    html += '</div>';
                }
                
                if (sample.preview?.success) {
                    html += '<div class="wbe-preview-stats">';
                    html += '<p>' + sample.preview.summary + '</p>';
                    html += '</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div></div>';
            
            this.$previewModal.find('#wbe-preview-content').html(html);
            this.$previewModal.show();
        },
        
        showLogsModal: function() {
            WBE.ajax('wbe_get_logs', {}, function(data) {
                let html = '<div class="wbe-logs-content">';
                
                if (data.logs && data.logs.length > 0) {
                    html += '<table class="wp-list-table widefat fixed striped">';
                    html += '<thead><tr>' +
                        '<th>' + (WBE.config.i18n?.timestamp || 'Timestamp') + '</th>' +
                        '<th>' + (WBE.config.i18n?.action || 'Action') + '</th>' +
                        '<th>' + (WBE.config.i18n?.details || 'Details') + '</th>' +
                        '</tr></thead><tbody>';
                    
                    data.logs.forEach(function(log) {
                        html += '<tr>';
                        html += '<td>' + log.timestamp + '</td>';
                        html += '<td>' + log.action + '</td>';
                        html += '<td>' + JSON.stringify(log.details) + '</td>';
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p class="wbe-empty-state">' + 
                        (WBE.config.i18n?.noLogs || 'Pas de logs disponibles.') + '</p>';
                }
                
                html += '</div>';
                
                $('#wbe-logs-modal').find('#wbe-logs-content').html(html);
                $('#wbe-logs-modal').show();
            });
        },
        
        showHelpModal: function() {
            this.$helpModal.show();
        },
        
        closeAllModals: function() {
            this.$modals.hide();
        }
    };

    window.WBE = WBE;

})(jQuery);